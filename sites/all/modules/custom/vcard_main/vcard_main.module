<?php
/**
 * @file
 * Module's main file.
 */

/**
 * Implements hook_menu().
 */
function vcard_main_menu() {
  $items = [];
  $weight = 1;

  $items['my-vcard'] = [
    'title' => 'My VCards',
    'menu_name' => 'main-menu',
    'weight' => $weight++,
    'page callback' => 'vcard_main_home_page',
    'access callback' => TRUE,
  ];
  $items['my-vcard/add'] = [
    'title' => 'Add VCard',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['vcard_main_my_vcard_form'],
    'access arguments' => ['access content'],
  ];
  $items['my-vcard/%/%'] = [
    'title callback' => 'vcard_main_my_vcard_form_edit_title',
    'title arguments' => [2],
    'page callback' => 'drupal_get_form',
    'page arguments' => ['vcard_main_my_vcard_form', 1, 2],
    'access arguments' => ['access content'],
  ];
  $items['my-vcard/%/remove'] = [
    'title' => 'Remove VCard',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['vcard_main_my_vcard_form_remove', 1],
    'access arguments' => ['access content'],
  ];
  $items['contacts'] = [
    'title' => 'Contacts',
    'menu_name' => 'main-menu',
    'weight' => $weight++,
    'page callback' => 'drupal_get_form',
    'page arguments' => ['vcard_main_contacts_form'],
    'access arguments' => ['access content'],
  ];
  $items['groups'] = [
    'title' => 'Groups',
    'menu_name' => 'main-menu',
    'weight' => $weight++,
    'page callback' => 'drupal_get_form',
    'page arguments' => ['vcard_main_groups_form'],
    'access arguments' => ['access content'],
  ];
  $items['history'] = [
    'title' => 'History',
    'menu_name' => 'main-menu',
    'weight' => $weight++,
    'page callback' => 'drupal_get_form',
    'page arguments' => ['vcard_main_history_form'],
    'access arguments' => ['access content'],
  ];
  $items['logout'] = [
    'title' => 'Log Out',
    'menu_name' => 'main-menu',
    'weight' => $weight++,
    'page callback' => 'vcard_main_logout',
    'access arguments' => ['access content'],
  ];

  return $items;
}

/**
 * Home page callback.
 */
function vcard_main_home_page() {
  global $user;

  $page = [];

  // Show elements for authorized users only.
  if ($user->uid) {
    $page['vcard-add'] = [
      '#type' => 'link',
      '#href' => 'my-vcard/add',
      '#title' => t('Add new VCard'),
    ];
  }

  return $page;
}

/**
 * Page callback for add, edit and clone VCards.
 *
 * @param $form
 * @param $form_state
 * @param integer|null $id
 *  VCard existing entity id.
 * @param string|null $op
 *  'edit'
 *  'clone'
 *
 * @return mixed
 */
function vcard_main_my_vcard_form($form, &$form_state, $id = NULL, $op = NULL) {
  global $user;

  // Show elements for authorized users only.
  if ($user->uid) {
    $user_entity = entity_load_single('user', $user->uid);

    if (is_numeric($id)) {
      $vcard_entity = entity_load_single('vcard', $id);
      if ($op == 'clone') {
        module_load_include('inc', 'entity', 'includes/entity.ui');
        $vcard_entity = entity_ui_clone_entity('vcard', $vcard_entity);
      }
    }
    else {
      $vcard_entity = entity_create('vcard', ['type' => 'vcard']);
    }

    field_attach_form('vcard', $vcard_entity, $form, $form_state);

    $form['entity'] = [
      '#type' => 'value',
      '#value' => $vcard_entity,
    ];
    $form['user_entity'] = [
      '#type' => 'value',
      '#value' => $user_entity,
    ];

    $form['submit'] = [
      '#type' => 'submit',
      '#value' => t('Save'),
      '#weight' => 100,
      '#attributes' => [
        'id' => 'my-vcard-form-submit',
      ],
    ];

    $form['#validate'][] = 'vcard_main_my_vcard_form_validation';
    $form['#submit'][] = 'vcard_main_my_vcard_form_submit';
  }

  return $form;
}

/**
 * "My VCard" page form validation.
 */
function vcard_main_my_vcard_form_validation($form, &$form_state) {
  field_attach_form_validate('vcard', $form_state['values']['entity'], $form, $form_state);
}

/**
 * "My VCard" page form submit.
 */
function vcard_main_my_vcard_form_submit($form, &$form_state) {
  // Save VCard entity.
  $entity = $form_state['values']['entity'];
  field_attach_submit('vcard', $entity, $form, $form_state);
  entity_save('vcard', $entity);

  // Save relations to user.
  $user = $form_state['values']['user_entity'];
  $wrapper = entity_metadata_wrapper('user', $user);
  if (isset($wrapper->field_vcard)) {
    $vcard_field = $wrapper->field_vcard->value();
    $ids = [];
    foreach ($vcard_field as $item) {
      $ids[] = $item->id;
    }
    // Save if new VCard created.
    if (!array_search($entity->id, $ids)) {
      $wrapper->field_vcard[] = intval($entity->id);
    }
  }
  else {
    watchdog('error', t('Field \'vcard\' does not exists for user.'));
  }
  $wrapper->save();

  // @todo Write good message.
  drupal_set_message(t('Your visit card successfully saved!'));
  drupal_goto('<front>');
}

/**
 * Page callback for deleting VCards.
 */
function vcard_main_my_vcard_form_remove($form, &$form_state, $id) {
  $wrapper = entity_metadata_wrapper('vcard', $id);
  $src = $wrapper->field_json->value();

  $form['image'] = [
    '#type' => 'item',
    '#markup' => '<img src="' . $src . '" class="vcard-rendered" />',
  ];

  $form['id'] = [
    '#type' => 'value',
    '#value' => $id,
  ];
  return confirm_form(
    $form,
    t('Are you sure to delete the VCard?'),
    '<front>',
    t('This action cannot be undone.'),
    t('Delete'),
    t('Cancel'));
}

/**
 * VCard remove form submit.
 */
function vcard_main_my_vcard_form_remove_submit($form, &$form_state) {
  global $user;

  if ($form_state['values']['confirm']) {
    $id = $form_state['values']['id'];

    // Remove relations from "user" first.
    $wrapper = entity_metadata_wrapper('user', $user);
    foreach ($wrapper->field_vcard->value() as $key => $item) {
      if ($item->id == $id) {
        $wrapper->field_vcard[$key]->set(NULL);
        break;
      }
    }
    $wrapper->save();

    // Remove vcard entity.
    entity_delete('vcard', $id);
  }

  $form_state['redirect'] = '<front>';
}

/**
 * "Contacts" page callback.
 */
function vcard_main_contacts_form($form, &$form_state) {
  return $form;
}

/**
 * "Groups" page callback.
 */
function vcard_main_groups_form($form, &$form_state) {
  return $form;
}

/**
 * "History" page callback.
 */
function vcard_main_history_form($form, &$form_state) {
  return $form;
}

/**
 * "Log Out" page callback.
 */
function vcard_main_logout() {
  module_load_include('inc', 'user', 'user.pages');
  user_logout();
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function vcard_main_form_user_login_block_alter(&$form, &$form_state) {
  $form['name']['#title_display'] = 'invisible';
  $form['name']['#attributes'] = ['placeholder' => t('E-mail')];
  $form['pass']['#title_display'] = 'invisible';
  $form['pass']['#attributes'] = ['placeholder' => t('Password')];
}

/**
 * Implements hook_block_view_alter().
 */
function vcard_main_block_view_alter(&$data, $block) {
  switch ($block->delta) {
    case 'login':
      // Remove unnecessary title.
      unset($data['subject']);
      // Set link after "Log in" button.
      $data['content']['links']['#weight'] = 101;
      // Hide unnecessary links.
      $data['content']['links']['#access'] = FALSE;
      // Set google button on the top of block.
      $data['content']['submit_google']['#weight'] = -1;
      break;
  }
}

/**
 * Title callback for My VCard operations.
 *
 * @param $op
 *  Edit or Clone.
 *
 * @return string
 */
function vcard_main_my_vcard_form_edit_title($op) {
  return t('@op VCard', ['@op' => $op == 'edit' ? 'Edit' : 'Add']);
}

/**
 * Implements hook_page_alter().
 */
function vcard_main_page_alter(&$page) {
  global $user;

  // Show elements for authorized users only.
  if ($user->uid) {
    $user_entity = entity_load_single('user', $user->uid);
    // If new user hasn't any VCard show hint.
    if (arg(1) != 'add' && empty($user_entity->field_vcard)) {
      $message = t(
        'Hint: To start using this service you need to fill some fields in your profile. Add <a href="@my_vcard">My first VCard</a>.',
        ['@my_vcard' => url('my-vcard/add')]
      );

      $page['content']['hint'] = [
        '#markup' => '
            <div class="hint-outer">
                <div class="hint-inner">
                    <p>' . $message . '</p>
                    <div class="hint-bottom-triangle"></div>
                </div>
            </div>
        ',
      ];

      $this_module = drupal_get_path('module', 'vcard_main');
      $page['content']['hint']['#attached'] = [
        'css' => [
          "$this_module/css/hint.css",
        ],
        'js' => [
          "$this_module/js/hint.js",
        ],
      ];
    }
  }
}
